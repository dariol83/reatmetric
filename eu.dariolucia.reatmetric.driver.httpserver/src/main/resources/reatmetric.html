<html>
    <head>
        <script type="text/javascript" src="reatmetric.js">
        </script>
        <script type="text/javascript">
    var reatmetric = new ReatMetric('127.0.0.1',8081,'Test System');
    var subEvtKey = null;
    var subParamKey = null;
    var subMsgKey = null;

    var tableBodyVar = null;

    var parameterMap = null;

    var subIntervalId = null;

    function createTable(divToAttach, thTextArray) {
        // Table and header
        var tableNode = document.createElement('table');
        divToAttach.appendChild(tableNode);
        var theadNode = document.createElement('thead');
        tableNode.appendChild(theadNode);
        var trNode = document.createElement('tr');
        theadNode.appendChild(trNode);

        for(var colname of thTextArray) {
            var thNode = document.createElement('th');
            thNode.textContent = colname;
            trNode.appendChild(thNode);
        }

        // Create tbody
        var tbodyNode = document.createElement('tbody');
        tableNode.appendChild(tbodyNode);
        return tbodyNode;
    }

    function addRow(tbodyNode, obj, tdTextArrayKeys) {
        var addedTds = new Object();
        var pTrNode = document.createElement('tr');
        for(var tdkey of tdTextArrayKeys) {
            var tdNode = document.createElement('td');
            tdNode.textContent = obj[tdkey];
            pTrNode.appendChild(tdNode);
            addedTds[tdkey] = tdNode;
        }
        tbodyNode.appendChild(pTrNode);
        return addedTds;
    }

    async function showParameters() {
        var divToAttach = document.getElementById('div1');
        divToAttach.textContent = '';

        var thTextArray = ['Path', 'External ID', 'Description', 'Unit'];
        var tdTextArrayKeys = ['path', 'externalId', 'description', 'unit'];

        var params = await reatmetric.listParameters();
        if(params != null) {
            // Create table node
            var tbodyNode = createTable(divToAttach, thTextArray)
            for(var i = 0; i < params.length; ++i) {
                var param = params[i];
                addRow(tbodyNode, param, tdTextArrayKeys);
            }
        }
    }

    async function showEvents() {
        var divToAttach = document.getElementById('div1');
        divToAttach.textContent = '';

        var thTextArray = ['Path', 'External ID', 'Description', 'Severity'];
        var tdTextArrayKeys = ['path', 'externalId', 'description', 'severity'];

        var events = await reatmetric.listEvents();
        if(events != null) {
            // Create table node
            var tbodyNode = createTable(divToAttach, thTextArray)
            for(var i = 0; i < events.length; ++i) {
                var event = events[i];
                addRow(tbodyNode, event, tdTextArrayKeys);
            }
        }
    }

    async function subscribeToEvents() {
        if(subEvtKey != null) {
            return;
        }
        await unsubscribeFromParameters();
        await unsubscribeFromMessages();

        var divToAttach = document.getElementById('div1');
        divToAttach.textContent = '';

        // Create table node
        var thTextArray = ['Severity', 'Gen. Time', 'Path', 'Route', 'Source'];
        tableBodyVar = createTable(divToAttach, thTextArray)

        var filter = reatmetric.eventFilter('STATION', null, null, null, null, null, null);

        subEvtKey = await reatmetric.registerToEvents(filter);
        console.log("Event subscription key: " + subEvtKey);
        if(subEvtKey != null) {
            subIntervalId = setInterval(evtRetrieve, 1000);
            console.log("Event subscription interval: " + subIntervalId);
        }
    }

    async function evtRetrieve() {
        console.log("Retrieving events on key " + subEvtKey);
        var currentEvents = null;
        if(subEvtKey != null) {
            currentEvents = await reatmetric.getEvents(subEvtKey)
        }
        var tdTextArrayKeys = ['severity', 'gentime', 'path', 'route', 'source'];

        if(currentEvents != null) {
            console.log("Retrieved " + currentEvents.length + " events");
            for(var i = 0; i < currentEvents.length; ++i) {
                var event = currentEvents[i];
                addRow(tableBodyVar, event, tdTextArrayKeys);
            }
        }
    }

    async function unsubscribeFromEvents() {
        if(subEvtKey == null) {
            return;
        }
        clearInterval(subIntervalId);
        subIntervalId = null;
        await reatmetric.deregisterFromEvents(subEvtKey);
        subEvtKey = null;
    }

    async function subscribeToParameters() {
        if(subParamKey != null) {
            return;
        }
        await unsubscribeFromEvents();
        await unsubscribeFromMessages();

        var divToAttach = document.getElementById('div1');
        divToAttach.textContent = '';

        var filter = reatmetric.parameterFilter('STATION', null, null, null, null, null);

        // Create table node
        var thTextArray = ['Path', 'Gen. Time', 'Raw Value', 'Eng. Value', 'Validity', 'Alarm State'];
        tableBodyVar = createTable(divToAttach, thTextArray)
        parameterMap = [];

        subParamKey = await reatmetric.registerToStateParameters(filter);
        console.log("Parameter subscription key: " + subParamKey);
        if(subParamKey != null) {
            subIntervalId = setInterval(paramRetrieve, 1000);
            console.log("Parameter subscription interval: " + subIntervalId);
        }
    }

    async function paramRetrieve() {
        var currentParameters = null;
        if(subParamKey != null) {
            currentParameters = await reatmetric.getStateParameters(subParamKey)
        }
        if(currentParameters != null) {
            var paramKeys = ['path', 'gentime', 'raw', 'eng', 'validity', 'alarm'];
            for(var i = 0; i < currentParameters.length; ++i) {
                var param = currentParameters[i];
                if(parameterMap[param['path']] != null) {
                    for(var tdkey of paramKeys) {
                        var theTdArray = parameterMap[param['path']];
                        theTdArray[tdkey].textContent = param[tdkey];
                    }
                } else {
                    parameterMap[param['path']] = addRow(tableBodyVar, param, paramKeys);
                }
            }
        }
    }

    async function unsubscribeFromParameters() {
        if(subParamKey == null) {
            return;
        }
        clearInterval(subIntervalId);
        subIntervalId = null;
        await reatmetric.deregisterFromStateParameters(subParamKey);
        subParamKey = null;
        parameterMap = null;
    }

    async function subscribeToMessages() {
        if(subMsgKey != null) {
            return;
        }
        await unsubscribeFromEvents();
        await unsubscribeFromParameters();

        var divToAttach = document.getElementById('div1');
        divToAttach.textContent = '';

        // Create table node
        var thTextArray = ['Severity', 'Gen. Time', 'Source', 'Message'];
        tableBodyVar = createTable(divToAttach, thTextArray)

        var filter = reatmetric.messageFilter(null, null, null, null);

        subMsgKey = await reatmetric.registerToMessages(filter);
        console.log("Message subscription key: " + subMsgKey);
        if(subMsgKey != null) {
            subIntervalId = setInterval(msgRetrieve, 1000);
            console.log("Parameter subscription interval: " + subIntervalId);
        }
    }

    async function msgRetrieve() {
        var currentMessages = null;
        if(subMsgKey != null) {
            currentMessages = await reatmetric.getMessages(subMsgKey)
        }
        if(currentMessages != null) {
            var tdTextArrayKeys = ['severity', 'gentime', 'source', 'message'];
            for(var i = 0; i < currentMessages.length; ++i) {
                var messg = currentMessages[i];
                addRow(tableBodyVar, messg, tdTextArrayKeys);
            }
        }
    }

    async function unsubscribeFromMessages() {
        if(subMsgKey == null) {
            return;
        }
        clearInterval(subIntervalId);
        subIntervalId = null;
        await reatmetric.deregisterFromMessages(subMsgKey);
        subMsgKey = null;
    }

        </script>
        <style>
          .tableFixHead {
            overflow-y: auto;
            height: 85%;
            font-size: 9px;
          }
          .tableFixHead thead th {
            position: sticky;
            top: 0;
            font-size: 9px;
          }
          table {
            border-collapse: collapse;
            width: 100%;
          }
          th,
          td {
            padding: 8px 16px;
            border: 1px solid #ccc;
            font-size: 9px;
          }
          th {
            background: #eee;
          }
        </style>
    </head>
    <body>
        <button type="button" onclick="showParameters()">Show Parameters</button>
        <button type="button" onclick="showEvents()">Show Events</button>
        <button type="button" onclick="subscribeToEvents()">Subscribe to events</button>
        <button type="button" onclick="unsubscribeFromEvents()">Unsubscribe from events</button>
        <button type="button" onclick="subscribeToParameters()">Subscribe to parameters</button>
        <button type="button" onclick="unsubscribeFromParameters()">Unsubscribe from parameters</button>
        <button type="button" onclick="subscribeToMessages()">Subscribe to messages</button>
        <button type="button" onclick="unsubscribeFromMessages()">Unsubscribe from messages</button>
        <hr/>
        <br/>
        <div id="div1" class="tableFixHead">
        </div>
        <br/>
    </body>
</html>
