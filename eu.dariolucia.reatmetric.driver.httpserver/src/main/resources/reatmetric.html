<html>
    <head>
        <script type="text/javascript" src="reatmetric.js">
        </script>
        <script type="text/javascript">
    var reatmetric = new ReatMetric('127.0.0.1',8081,'Test System');
    var subEvtKey = null;
    var subParamKey = null;
    var subMsgKey = null;

    var subIntervalId = null;

    async function showParameters() {
        var divToAttach = document.getElementById('div1');
        divToAttach.textContent = '';
        var params = await reatmetric.listParameters();
        if(params != null) {
            for(var i = 0; i < params.length; ++i) {
                var param = params[i];
                var pNode = document.createElement('p');
                pNode.textContent = param.path + " (" + param.externalId + "): " + param.description + " - Unit: " + param.unit;
                divToAttach.appendChild(pNode);
            }
        }
    }

    async function showEvents() {
        var divToAttach = document.getElementById('div1');
        divToAttach.textContent = '';
        var events = await reatmetric.listEvents();
        if(events != null) {
            for(var i = 0; i < events.length; ++i) {
                var event = events[i];
                var pNode = document.createElement('p');
                pNode.textContent = event.path + " (" + event.externalId + "): " + event.description + " - Severity: " + event.severity;
                divToAttach.appendChild(pNode);
            }
        }
    }

    async function subscribeToEvents() {
        if(subEvtKey != null) {
            return;
        }
        await unsubscribeFromParameters();
        await unsubscribeFromMessages();

        var divToAttach = document.getElementById('div1');
        divToAttach.textContent = '';

        var filter = reatmetric.eventFilter('STATION', null, null, null, null, null, null);

        subEvtKey = await reatmetric.registerToEvents(filter);
        console.log("Event subscription key: " + subEvtKey);
        if(subEvtKey != null) {
            subIntervalId = setInterval(evtRetrieve, 1000);
            console.log("Event subscription interval: " + subIntervalId);
        }
    }

    async function evtRetrieve() {
        console.log("Retrieving events on key " + subEvtKey);
        var currentEvents = null;
        if(subEvtKey != null) {
            currentEvents = await reatmetric.getEvents(subEvtKey)
        }
        if(currentEvents != null) {
            console.log("Retrieved " + currentEvents.length + " events");
            var divToAttach = document.getElementById('div1');
            for(var i = 0; i < currentEvents.length; ++i) {
                var event = currentEvents[i];
                var pNode = document.createElement('p');
                pNode.textContent = event.severity + " (" + event.gentime + "): " + event.path + " - Route: " + event.route + ", Source: " + event.source;
                divToAttach.appendChild(pNode);
            }
        }
    }

    async function unsubscribeFromEvents() {
        if(subEvtKey == null) {
            return;
        }
        clearInterval(subIntervalId);
        subIntervalId = null;
        await reatmetric.deregisterFromEvents(subEvtKey);
        subEvtKey = null;
    }

    async function subscribeToParameters() {
        if(subParamKey != null) {
            return;
        }
        await unsubscribeFromEvents();
        await unsubscribeFromMessages();

        var divToAttach = document.getElementById('div1');
        divToAttach.textContent = '';

        var filter = reatmetric.parameterFilter('STATION', null, null, null, null, null);

        subParamKey = await reatmetric.registerToStateParameters(filter);
        console.log("Parameter subscription key: " + subParamKey);
        if(subParamKey != null) {
            subIntervalId = setInterval(paramRetrieve, 1000);
            console.log("Parameter subscription interval: " + subIntervalId);
        }
    }

    async function paramRetrieve() {
        console.log("Retrieving parameters on key " + subParamKey);
        var currentParameters = null;
        if(subParamKey != null) {
            currentParameters = await reatmetric.getStateParameters(subParamKey)
        }
        if(currentParameters != null) {
            console.log("Retrieved " + currentParameters.length + " parameters");
            var divToAttach = document.getElementById('div1');
            for(var i = 0; i < currentParameters.length; ++i) {
                var param = currentParameters[i];
                var pNode = document.createElement('p');
                pNode.textContent = param.alarm + " (" + param.gentime + "): " + param.path + " - Raw Value: " + param.raw + ", Eng. Value: " + param.eng;
                divToAttach.appendChild(pNode);
            }
        }
    }

    async function unsubscribeFromParameters() {
        if(subParamKey == null) {
            return;
        }
        clearInterval(subIntervalId);
        subIntervalId = null;
        await reatmetric.deregisterFromStateParameters(subParamKey);
        subParamKey = null;
    }

    async function subscribeToMessages() {
        if(subMsgKey != null) {
            return;
        }
        await unsubscribeFromEvents();
        await unsubscribeFromParameters();

        var divToAttach = document.getElementById('div1');
        divToAttach.textContent = '';

        var filter = reatmetric.messageFilter(null, null, null, null);

        subMsgKey = await reatmetric.registerToMessages(filter);
        console.log("Parameter subscription key: " + subMsgKey);
        if(subMsgKey != null) {
            subIntervalId = setInterval(msgRetrieve, 1000);
            console.log("Parameter subscription interval: " + subIntervalId);
        }
    }

    async function msgRetrieve() {
        console.log("Retrieving parameters on key " + subParamKey);
        var currentMessages = null;
        if(subMsgKey != null) {
            currentMessages = await reatmetric.getMessages(subMsgKey)
        }
        if(currentMessages != null) {
            console.log("Retrieved " + currentMessages.length + " parameters");
            var divToAttach = document.getElementById('div1');
            for(var i = 0; i < currentMessages.length; ++i) {
                var messg = currentMessages[i];
                var pNode = document.createElement('p');
                pNode.textContent = messg.severity + " (" + messg.gentime + "): " + messg.text + " - Source: " + messg.source;
                divToAttach.appendChild(pNode);
            }
        }
    }

    async function unsubscribeFromMessages() {
        if(subMsgKey == null) {
            return;
        }
        clearInterval(subIntervalId);
        subIntervalId = null;
        await reatmetric.deregisterFromMessages(subMsgKey);
        subMsgKey = null;
    }

        </script>
    </head>
    <body>
        <button type="button" onclick="showParameters()">Show Parameters</button>
        <button type="button" onclick="showEvents()">Show Events</button>
        <button type="button" onclick="subscribeToEvents()">Subscribe to events</button>
        <button type="button" onclick="unsubscribeFromEvents()">Unsubscribe to events</button>
        <button type="button" onclick="subscribeToParameters()">Subscribe to parameters</button>
        <button type="button" onclick="unsubscribeFromParameters()">Unsubscribe to events</button>
        <button type="button" onclick="subscribeToMessages()">Subscribe to messages</button>
        <button type="button" onclick="unsubscribeFromMessages()">Unsubscribe to messages</button>
        <hr/>
        <br/>
        <div id="div1">
        </div>
        <br/>
    </body>
</html>
